{% extends "base.html" %}

{% block head_title %}Ganti Sandi{% endblock %}

{% block content %}
<div class="shadow-wrap">
    <div class="form-wrap">
        <h2 style="text-align: center;">Ganti Sandi Anda</h2>
        <p>Silakan masukkan sandi lama Anda, lalu masukkan sandi baru Anda dua kali.</p>
        
        {# PASTIKAN FORM MEMILIKI ID YANG TEPAT #}
        <form method="post" id="password_change_form">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                    {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}

            <div class="form-group mb-3">
                <label for="{{ form.old_password.id_for_label }}">Sandi lama:</label>
                {{ form.old_password }}
                {% for error in form.old_password.errors %}<div class="error">{{ error }}</div>{% endfor %}
            </div>

            <div class="form-group mb-3">
                <label for="{{ form.new_password1.id_for_label }}">Sandi baru:</label>
                {{ form.new_password1 }}
                {% if form.new_password1.help_text %}<div class="form-text text-muted small mt-1">{{ form.new_password1.help_text|safe }}</div>{% endif %}
                {% for error in form.new_password1.errors %}<div class="error">{{ error }}</div>{% endfor %}
            </div>

            <div class="form-group mb-3">
                <label for="{{ form.new_password2.id_for_label }}">Konfirmasi sandi baru:</label>
                {{ form.new_password2 }}
                {% for error in form.new_password2.errors %}<div class="error">{{ error }}</div>{% endfor %}
            </div>

            <input type="hidden" name="g-recaptcha-response" id="id_g-recaptcha-response">

            <button type="submit" class="btn btn-primary mt-3 w-100">Simpan Perubahan</button>
        </form>
    </div>
</div>

<script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_V3_SITE_KEY }}"></script>
<script>
    document.getElementById('password_change_form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        grecaptcha.ready(function() {
            grecaptcha.execute('{{ RECAPTCHA_V3_SITE_KEY }}', {action: 'password_change'}).then(function(token) {
                document.getElementById('id_g-recaptcha-response').value = token;
                document.getElementById('password_change_form').submit();
            });
        });
    });
</script>
{% endblock %}