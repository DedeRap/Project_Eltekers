{% extends "base.html" %}
{% load i18n %}

{% block head_title %}Verifikasi OTP Reset Password{% endblock %}

{% block content %}
<div class="shadow-wrap">
    <div class="form-wrap">
        <h2 style="text-align: center;">Masukkan Kode OTP</h2>
        <p>Kami telah mengirimkan kode verifikasi ke nomor telepon Anda. Silakan masukkan di bawah ini.</p>
        
        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="otp">Kode OTP:</label>
                <input type="text" name="otp" required id="id_otp" class="form-control" placeholder="Masukkan 6-digit kode" autofocus>
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100">Verifikasi</button>
            {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
            {% endif %}
        </form>
        <div class="mt-4 text-center">
            <a id="resend-link" href="{% url 'password_reset_resend_otp' %}" style="display: none;">Kirim Ulang OTP</a>
            <span id="resend-message">Kirim ulang OTP dalam <span id="countdown"></span>.</span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ambil waktu kedaluwarsa dari context view
        const expiryTimestamp = {{ otp_expiry_timestamp }};
        const countdownElement = document.getElementById('countdown');
        const resendLink = document.getElementById('resend-link');
        const resendMessage = document.getElementById('resend-message');

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = expiryTimestamp - now;

            // Jika waktu sudah habis
            if (distance < 0) {
                clearInterval(interval);
                resendLink.style.display = 'inline'; // Tampilkan link "Kirim Ulang"
                resendMessage.style.display = 'none'; // Sembunyikan pesan countdown
                return;
            }

            // Hitung sisa menit dan detik
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            // Tampilkan di halaman
            countdownElement.innerHTML = minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
        }

        // Jalankan fungsi setiap 1 detik
        const interval = setInterval(updateCountdown, 1000);
        updateCountdown(); // Jalankan sekali saat halaman dimuat
    });
</script>
{% endblock %}